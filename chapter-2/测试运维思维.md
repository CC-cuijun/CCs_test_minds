# 测试运维思维

&#8195;&#8195;测试为什么需要像运维一样的思考呢？一个高可用，维护方便，日志简明方便排查问题，服务及业务可监控，安全防范强的高质量系统是运维最喜欢的，所以对我们所交付运维的服务及模块有很高的质量要求。同时也要求测试同学能有一些运维知识或者说对系统层面有一定的认识，才能更好的排查定位问题，能对开发的交付质量有更多维度的考量。

## 看先看一些例子：

### 系统相关：
* HBASE有个别节点挂掉（一次NTP同步问题）
* lvs调度算法设置错误（导致没有流量均衡到后端服务）
* hosts文件导致的问题没有通过DNS解析（每个服务配置DNS，每一次变更都需要更改配置，为什么不配置DNS呢？）
* 系统的容灾恢复能力（tomcat由于服务过多导致启动需要10分钟以上，对业务影响时间太长）

### 交付质量相关：
* CPUload异常升高（发布时日志等级设置错误/不合理的日志打印，都会导致大量磁盘IO）
* 系统的平行扩展能力（由于只能建立一个连接导致不支持平行扩展，需要拆分服务，优化架构）

## 哪些东西是值得我们去思考的呢？
* 部署规范（了解运维自动化部署方式）
* 服务器性能监控方式(可视化的监控，曾经的运维就是靠各种脚本+定时任务做日常监控)
  * Zabbix/Grafana（可以读懂各项指标）
* 业务监控分析（请求异常、统计、业务流量监控等）
* 日志规范: _不规范对日志输出将导致运维无法排错，占据大量的磁盘空间（影响成本），影响日志回滚策略，大量的磁盘IO对性能影响非常明显。_
* 数据库规范（DBA）:_如:备份策略，数据库相关的知识_
* linux相关知识
  - 常用命令
  - shell脚本
  - 端口监控
  - 关注内存（关注jvm，关注GC）
  - 关注cpuload
  - 关注网卡（会抓包分析）
  - 关注磁盘空间
* 网络相关知识
  - TCP/IP
    - 1.链路层（数据链路层/网络接口层）：包括操作系统中的设备驱动程序、计算机中对应的网络接口卡 
    - 2.网络层（互联网层）：处理分组在网络中的活动，比如分组的选路。 
    - 3.传输层：主要为两台主机上的应用提供端到端的通信。 
    - 4.应用层：负责处理特定的应用程序细节。
  - OSI参考模型：应用层、表示层、会话层、传输层、网络层、数据链路层、物理层
  - 路由/交换机
  - 负载均衡lvs等
    - 四层 lvs
    - haproxy
    - 七层 nginx
    - 算法：随机、轮询、加权轮询、最少连接法
    - K8s高可用方案
  - 一次完整的浏览器请求过程 
    -  在地址栏输入URL并回车，浏览器查询域名的IP。一般会有以下几个地方：浏览器缓存、操作系统缓存、路由器缓存、本地DNS服务器，如果本地DNS服务器上没有的话，它会递归的从根DNS服务器、顶级DNS服务器、权威DNS服务器请求，然后把获取到的IP返回给浏览器（DNS协议基于UDP）。浏览器向web服务器发送HTTP请求(HTTP 协议基于TCP)，建立连接需要经过三次握手，并且该连接是长连接，即keep-alive. IP数据包在网络传输中还需要经过域间选路和域内选路。若长时间接收不到应答，TCP会进行重传和拥塞控制。web服务器接收并处理请求，web服务器回传一个HTTP响应，浏览器接收到以后解析HTML并显示，浏览器请求嵌入在HTML中的对象 最终浏览器呈现一个图文并茂的页面。
* 有兴趣可以自己部署一些常见的服务去学习和了解

### 服务日志测试
- 日志等级设置是否合理
> log4j.rootLogger=debug,stdout,logfile  
- 日志格式是否标准
- 是否方便跟踪服务运行状况
- 是否压缩/回滚

### 负载均衡测试
- 调度算法
- 健康检查
- 服务平行扩展（动态检查）
- 负载能力（压测）
  - 配置
  - 部署方式

### 性能测试（以后做专题，可参考[附录6. 性能测试之过程分析](/appendix/性能测试之过程分析.md)）：
&#8195;&#8195;一般性能测试都是单独计划，单独执行，但测试过程是一个综合过程，其中会接触到很多的性能相关的功能，如：导出功能就涉及到性能（同步/异步、文件大小限制、时间、超时、如何拆分文件，任务管理等）
 > TPS：这个是一个综合指标，是要带很多条件的，服务器配置，业务节点规模，网络因素等都需要考虑，所以要有明确的测试目的，结合测试策略才能得出相对准确的性能报告。比如：8核16g的服务器理论上比4核8g的服务器TPS应该翻倍，所以单独一个业务指标TPS，或者性能如何，其实是没有任何意义的。
